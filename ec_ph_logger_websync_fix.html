<!doctype html>
<html lang='en'><head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'>
<title>EC & pH Runoff Logger (Web Sync – Fixed)</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .ok{background:#ecfdf5}.bad{background:#fef2f2}
  th.sortable{cursor:pointer; user-select:none}
  th.sortable .arrow{opacity:.5; margin-left:.35rem}
</style>
</head>
<body class='bg-gray-50 text-gray-900'>
<div class='max-w-6xl mx-auto p-6 space-y-6'>
  <div class='flex items-center justify-between flex-wrap gap-3'>
    <h1 class='text-2xl font-semibold'>EC & pH Runoff Logger <span class="text-sm text-gray-500">(Web Sync – Fixed)</span></h1>
    <div class='flex flex-wrap gap-2 items-center'>
      <div class="flex items-center gap-2">
        <label class="text-sm">Sync to Web</label>
        <input id="enableSync" type="checkbox" class="h-4 w-4">
      </div>
      <span id="syncStatus" class="text-xs px-2 py-1 rounded bg-gray-100">offline</span>
      <button id='pullRemote' class='px-3 py-2 border rounded'>Pull from Web</button>
      <button id='pushAll' class='px-3 py-2 border rounded'>Push All</button>
      <button id='exportCSV' class='px-3 py-2 border rounded'>Export CSV</button>
      <button id='exportJSON' class='px-3 py-2 border rounded'>Export JSON</button>
      <label class='px-3 py-2 border rounded cursor-pointer'>Import JSON
        <input id='importJSON' type='file' accept='application/json' class='hidden'>
      </label>
      <button id='clearAll' class='px-3 py-2 border rounded'>Clear All</button>
    </div>
  </div>

  <section class='bg-white rounded-2xl shadow p-4 space-y-4'>
    <h2 class='text-lg font-semibold'>New Entry</h2>
    <div class='grid md:grid-cols-4 gap-4'>
      <div><label class='block text-sm mb-1'>Date</label><input id='date' type='date' class='w-full border rounded px-3 py-2'></div>
      <div><label class='block text-sm mb-1'>Time (12h)</label><select id='time12' class='w-full border rounded px-3 py-2'></select></div>
      <div><label class='block text-sm mb-1'>Room</label><select id='room' class='w-full border rounded px-3 py-2'></select></div>
      <div><label class='block text-sm mb-1'>Bench</label><select id='bench' class='w-full border rounded px-3 py-2'></select></div>

      <div id='c_feedEC'><label class='block text-sm mb-1'>Irrigation EC (in)</label><select id='feedEC' class='w-full border rounded px-3 py-2'></select></div>
      <div id='c_feedPH'><label class='block text-sm mb-1'>Irrigation pH (in)</label><select id='feedPH' class='w-full border rounded px-3 py-2'></select></div>
      <div id='c_runoffEC'><label class='block text-sm mb-1'>Runoff EC (out)</label><select id='runoffEC' class='w-full border rounded px-3 py-2'></select></div>
      <div id='c_runoffPH'><label class='block text-sm mb-1'>Runoff pH (out)</label><select id='runoffPH' class='w-full border rounded px-3 py-2'></select></div>

      <div id='c_trayEC'><label class='block text-sm mb-1'>Capture Tray EC</label><select id='trayEC' class='w-full border rounded px-3 py-2'></select></div>
      <div id='c_trayPH'><label class='block text-sm mb-1'>Capture Tray pH</label><select id='trayPH' class='w-full border rounded px-3 py-2'></select></div>

      <div class='md:col-span-2'><label class='block text-sm mb-1'>Notes</label>
        <textarea id='notes' class='w-full border rounded px-3 py-2' placeholder='Dry-back %, salt ring, clogging, etc.'></textarea>
      </div>
      <div><label class='block text-sm mb-1'>Checked By</label><input id='checkedBy' class='w-full border rounded px-3 py-2' placeholder='Initials'></div>
      <div class='flex items-end gap-2'>
        <button id='add' class='px-3 py-2 bg-black text-white rounded'>Add Entry</button>
        <button id='saveRemoteOnly' class='px-3 py-2 border rounded'>Add & Push</button>
      </div>
    </div>
  </section>

  <section class='bg-white rounded-2xl shadow p-4 space-y-4'>
    <div class='flex items-center justify-between'>
      <h2 class='text-lg font-semibold'>Logs</h2>
      <input id='search' placeholder='Search notes / initials...' class='border rounded px-3 py-2 w-64' />
    </div>
    <div class='overflow-x-auto'>
      <table class='w-full text-sm' id='table'>
        <thead><tr class='text-left border-b'>
          <th data-k='date' class='py-2 sortable'>Date<span class='arrow'>↕</span></th>
          <th data-k='time' class='py-2 sortable'>Time<span class='arrow'>↕</span></th>
          <th data-k='room' class='py-2 sortable'>Room<span class='arrow'>↕</span></th>
          <th data-k='bench' class='py-2 sortable'>Bench<span class='arrow'>↕</span></th>
          <th data-k='feedEC' class='py-2 sortable'>Feed EC<span class='arrow'>↕</span></th>
          <th data-k='feedPH' class='py-2 sortable'>Feed pH<span class='arrow'>↕</span></th>
          <th data-k='runoffEC' class='py-2 sortable'>Runoff EC<span class='arrow'>↕</span></th>
          <th data-k='runoffPH' class='py-2 sortable'>Runoff pH<span class='arrow'>↕</span></th>
          <th data-k='trayEC' class='py-2 sortable'>Tray EC<span class='arrow'>↕</span></th>
          <th data-k='trayPH' class='py-2 sortable'>Tray pH<span class='arrow'>↕</span></th>
          <th data-k='notes' class='py-2 sortable'>Notes<span class='arrow'>↕</span></th>
          <th data-k='checkedBy' class='py-2 sortable'>Checked By<span class='arrow'>↕</span></th>
          <th class='py-2 text-right'>Actions</th>
        </tr></thead>
        <tbody id='tbody'><tr><td colspan='13' class='py-3 text-center text-gray-500'>No entries yet</td></tr></tbody>
      </table>
    </div>
  </section>

  <section class='bg-white rounded-2xl shadow p-4 space-y-3'>
    <h3 class='font-semibold'>Configure Web Sync</h3>
    <div class='grid md:grid-cols-2 gap-3'>
      <div>
        <label class='text-sm'>Web App Endpoint URL</label>
        <input id='endpoint' class='border rounded px-3 py-2 w-full' placeholder='https://script.google.com/macros/s/.../exec'>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class='text-sm'>Project (optional)</label>
          <input id='project' class='border rounded px-3 py-2 w-full' placeholder='sabzi-hill-cultivation'>
        </div>
        <div>
          <label class='text-sm'>Location (optional)</label>
          <input id='location' class='border rounded px-3 py-2 w-full' placeholder='Facility A'>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <div class="flex items-center gap-2">
        <label class="text-sm">Sync to Web</label>
        <input id="enableSyncFooter" type="checkbox" class="h-4 w-4">
      </div>
      <span id="syncStatusFooter" class="text-xs px-2 py-1 rounded bg-gray-100">offline</span>
    </div>
    <p class='text-xs text-gray-500'>No special headers are sent (avoids CORS preflight). If you added a secret key, include it as a query param in the endpoint URL.</p>
  </section>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const roomsBenches = { "Room 1":5, "Room 2":5, "Room 3":6, "Room 4":6 };
  const LS='ecph-logger-websync-fix-v1';
  const LSCFG='ecph-logger-websync-config-fix-v1';

  // Lists
  const EC = Array.from({length:31},(_,i)=>(1+i*0.1).toFixed(1));       // 1.0..4.0
  const PH = Array.from({length:21},(_,i)=>(5+i*0.1).toFixed(1));       // 5.0..7.0
  const TIME12 = [...Array(12).keys()].map(h=>`${h===0?12:h} AM`).concat([...Array(12).keys()].map(h=>`${h===0?12:h} PM`));

  function fillSelect(sel, arr){ sel.innerHTML=''; arr.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o);}); }

  // Populate selects
  fillSelect($('room'), Object.keys(roomsBenches));
  function renderBenches(){ fillSelect($('bench'), Array.from({length:roomsBenches[$('room').value]},(_,i)=>String(i+1))); }
  renderBenches();
  $('room').addEventListener('change', renderBenches);

  fillSelect($('time12'), TIME12);
  ['feedEC','runoffEC','trayEC'].forEach(id=>fillSelect($(id), EC));
  ['feedPH','runoffPH','trayPH'].forEach(id=>fillSelect($(id), PH));

  // Defaults
  const now=new Date();
  $('date').value = now.toISOString().slice(0,10);
  $('time12').value = (now.getHours()%12||12)+' '+(now.getHours()<12?'AM':'PM');

  // Load config
  let cfg = { endpoint: '', project: '', location: '' };
  try{ const raw = localStorage.getItem(LSCFG); if(raw) cfg = JSON.parse(raw);}catch{}
  $('endpoint').value = cfg.endpoint || '';
  $('project').value = cfg.project || '';
  $('location').value = cfg.location || '';
  $('enableSyncFooter').checked = !!cfg.endpoint;
  updateSyncStatus();

  ['endpoint','project','location'].forEach(id=>$(id).addEventListener('input', saveCfg));

  function saveCfg(){
    cfg.endpoint = $('endpoint').value.trim();
    cfg.project = $('project').value.trim();
    cfg.location = $('location').value.trim();
    localStorage.setItem(LSCFG, JSON.stringify(cfg));
    updateSyncStatus();
  }
  function updateSyncStatus(){
    const s2 = $('syncStatusFooter');
    const online = cfg.endpoint.length>0;
    s2.textContent = online ? 'online' : 'offline';
    s2.className = 'text-xs px-2 py-1 rounded ' + (online?'bg-emerald-100':'bg-gray-100');
  }

  // Local rows
  let rows = [];
  try{ const raw=localStorage.getItem(LS); if(raw) rows=JSON.parse(raw);}catch{}
  function save(){ localStorage.setItem(LS, JSON.stringify(rows)); render(); }

  // Search & Sort state
  let q = '';
  let sort = { key: 'date', dir: 'desc' }; // default sort by date desc

  $('search').addEventListener('input', (e)=>{ q = e.target.value.toLowerCase(); render(); });

  function cmp(a,b){
    const numCols = ['bench','feedEC','feedPH','runoffEC','runoffPH','trayEC','trayPH'];
    let va = a[sort.key], vb = b[sort.key];
    if (sort.key === 'date') { va = new Date(a.date||'1970-01-01').getTime(); vb = new Date(b.date||'1970-01-01').getTime(); }
    else if (numCols.includes(sort.key)) { va = parseFloat(va); vb = parseFloat(vb); if (isNaN(va)) va = -Infinity; if (isNaN(vb)) vb = -Infinity; }
    else { va = (va||'').toString().toLowerCase(); vb = (vb||'').toString().toLowerCase(); }
    return (va>vb?1:va<vb?-1:0) * (sort.dir==='asc'?1:-1);
  }
  function setSort(key){
    if (sort.key === key) sort.dir = (sort.dir==='asc'?'desc':'asc');
    else { sort.key = key; sort.dir = 'asc'; }
    render();
  }
  function renderHeaderSortIndicators(){
    document.querySelectorAll('th.sortable').forEach(th=>{
      const k = th.getAttribute('data-k'); const arrow = th.querySelector('.arrow');
      if (!arrow) return; arrow.textContent = (sort.key===k ? (sort.dir==='asc'?'↑':'↓') : '↕'); arrow.style.opacity = (sort.key===k ? '1' : '.5');
    });
  }
  document.querySelectorAll('th.sortable').forEach(th=> th.addEventListener('click', ()=>setSort(th.getAttribute('data-k'))));

  function render(){
    const tb=$('tbody'); tb.innerHTML='';
    let view = rows.filter(r=> (r.notes||'').toLowerCase().includes(q) || (r.checkedBy||'').toLowerCase().includes(q) );
    view.sort(cmp);

    if(!view.length){ const tr=document.createElement('tr'); tr.innerHTML=`<td colspan='13' class='py-3 text-center text-gray-500'>No entries yet</td>`; tb.appendChild(tr); renderHeaderSortIndicators(); return; }
    view.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class='py-2 px-1'>${r.date||''}</td>
        <td class='py-2 px-1'>${r.time||''}</td>
        <td class='py-2 px-1'>${r.room||''}</td>
        <td class='py-2 px-1'>${r.bench||''}</td>
        <td class='py-2 px-1'>${r.feedEC||''}</td>
        <td class='py-2 px-1'>${r.feedPH||''}</td>
        <td class='py-2 px-1'>${r.runoffEC||''}</td>
        <td class='py-2 px-1'>${r.runoffPH||''}</td>
        <td class='py-2 px-1'>${r.trayEC||''}</td>
        <td class='py-2 px-1'>${r.trayPH||''}</td>
        <td class='py-2 px-1 whitespace-pre-wrap max-w-[260px]'>${r.notes||''}</td>
        <td class='py-2 px-1'>${r.checkedBy||''}</td>
        <td class='py-2 px-1 text-right'><button data-e='${i}' class='px-2 py-1 border rounded mr-2'>Edit</button><button data-d='${i}' class='px-2 py-1 border rounded'>Delete</button></td>`;
      tb.appendChild(tr);
    });
    tb.querySelectorAll('[data-e]').forEach(b=>b.addEventListener('click',e=>edit(parseInt(e.target.getAttribute('data-e')))));
    tb.querySelectorAll('[data-d]').forEach(b=>b.addEventListener('click',e=>del(parseInt(e.target.getAttribute('data-d')))));
    renderHeaderSortIndicators();
  }

  function clearForm(){ ['feedEC','feedPH','runoffEC','runoffPH','trayEC','trayPH','notes','checkedBy'].forEach(id=>$(id).value=''); }
  let editIdx=null;

  $('add').addEventListener('click', ()=>{
    const rec = buildRecord();
    if(editIdx!==null){ rows[editIdx]=rec; editIdx=null; $('add').textContent='Add Entry'; }
    else { rows.unshift(rec); }
    save();
  });

  $('saveRemoteOnly').addEventListener('click', async ()=>{
    const rec = buildRecord();
    if (!cfg.endpoint) { alert('Set endpoint URL first.'); return; }
    try { const saved = await pushOne(rec); if (saved && saved.id) { rows.unshift(saved); save(); } }
    catch (e) { alert('Push failed: '+ e); }
  });

  function buildRecord(){
    return {
      date:$('date').value, time:$('time12').value,
      room:$('room').value, bench:$('bench').value,
      feedEC:$('feedEC').value, feedPH:$('feedPH').value,
      runoffEC:$('runoffEC').value, runoffPH:$('runoffPH').value,
      trayEC:$('trayEC').value, trayPH:$('trayPH').value,
      notes:$('notes').value, checkedBy:$('checkedBy').value,
      project:$('project').value, location:$('location').value
    };
  }

  function edit(i){
    const r=rows[i];
    $('date').value=r.date||''; $('time12').value=r.time||TIME12[0];
    $('room').value=r.room||Object.keys(roomsBenches)[0]; renderBenches(); $('bench').value=r.bench||'1';
    $('feedEC').value=r.feedEC||EC[0]; $('feedPH').value=r.feedPH||PH[0];
    $('runoffEC').value=r.runoffEC||EC[0]; $('runoffPH').value=r.runoffPH||PH[0];
    $('trayEC').value=r.trayEC||EC[0]; $('trayPH').value=r.trayPH||PH[0];
    $('notes').value=r.notes||''; $('checkedBy').value=r.checkedBy||'';
    editIdx=i; $('add').textContent='Save Changes'; window.scrollTo({top:0,behavior:'smooth'});
  }
  function del(i){ rows.splice(i,1); save(); }

  // CSV/JSON
  function toCSV(rows){
    const H=['Date','Time','Room','Bench','Feed EC','Feed pH','Runoff EC','Runoff pH','Tray EC','Tray pH','Notes','Checked By','Project','Location','ID'];
    const lines=rows.map(r=>[r.date,r.time,r.room,r.bench,r.feedEC,r.feedPH,r.runoffEC,r.runoffPH,r.trayEC,r.trayPH,(r.notes||'').replace(/\n/g,' '),r.checkedBy,r.project||'',r.location||'',r.id||''].map(x=>x??'').join(','));
    return [H.join(','),...lines].join('\n');
  }
  function download(name,content,mime){ const b=new Blob([content],{type:mime||'text/plain'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=name; a.click(); URL.revokeObjectURL(u); }
  $('exportCSV').addEventListener('click',()=>download('ecph_log.csv',toCSV(rows),'text/csv'));
  $('exportJSON').addEventListener('click',()=>download('ecph_log.json',JSON.stringify(rows,null,2),'application/json'));
  $('importJSON').addEventListener('change',e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(Array.isArray(d)){ rows=d; save(); } }catch{} }; r.readAsText(f); });
  $('clearAll').addEventListener('click',()=>{ if(confirm('Clear all saved entries?')){ rows=[]; save(); }});

  // Remote sync helpers (no custom headers; action on query string)
  function withAction(url, action) {
    const sep = url.includes('?') ? '&' : '?';
    return url + sep + 'action=' + encodeURIComponent(action);
  }

  async function pushOne(rec){
    // No Content-Type header to avoid preflight; Apps Script reads e.postData.contents
    const res = await fetch(withAction(cfg.endpoint, 'append'), {
      method: 'POST',
      body: JSON.stringify({ data: rec })
    });
    if (!res.ok) throw new Error(res.status+' '+res.statusText);
    return await res.json(); // expects {id: '...', ...rec}
  }
  async function pullAll(){
    const u = withAction(cfg.endpoint, 'list') + (cfg.project?('&project='+encodeURIComponent(cfg.project)):'') + (cfg.location?('&location='+encodeURIComponent(cfg.location)):''); 
    const res = await fetch(u);
    if (!res.ok) throw new Error(res.status+' '+res.statusText);
    return await res.json(); // expects array of rows
  }
  async function pushAll(){
    for (const r of rows) {
      if (!r.id) {
        try { const saved = await pushOne(r); r.id = saved.id; } catch(e){ console.error('push failed', e); }
      }
    }
    save();
  }

  document.getElementById('pullRemote').addEventListener('click', async ()=>{
    if (!cfg.endpoint) { alert('Set endpoint URL first.'); return; }
    try { const remote = await pullAll(); if (Array.isArray(remote)) { rows = remote; save(); } }
    catch (e) { alert('Pull failed: '+e); }
  });
  document.getElementById('pushAll').addEventListener('click', async ()=>{
    if (!cfg.endpoint) { alert('Set endpoint URL first.'); return; }
    await pushAll();
    alert('Push attempt completed (check console for any errors).');
  });

  render();
})();</script>
</body></html>
